-- Provides:
-- evil::mpd
--      artist (string)
--      song (string)
--      paused (boolean)
--      stopped (boolean)
local awful = require("awful")


local function emit_info()
  awful.spawn.easy_async({"mpc", "current"},
    function (stdout)
      if stdout == "" then
        awesome.emit_signal("evil::mpd", artist, title, status)
      else
      awful.spawn.easy_async({"mpc", "-f", "[[%artist%@@%title%@]]"},
        function(stdout)
          local artist = stdout:match('(.*)@@')
          local title = stdout:match('@@(.*)@')
          title = string.gsub(title, '^%s*(.-)%s*$', '%1')
          local status = stdout:match('%[(.*)%]')
          status = string.gsub(status, '^%s*(.-)%s*$', '%1')
          awesome.emit_signal("evil::mpd", artist, title, status)
        end
      )
      end
    end
  )
end

-- Run once to initialize widgets
emit_info()

-- Sleeps until mpd changes state (pause/play/next/prev)
local mpd_script = [[
  sh -c '
    mpc idleloop player
  ']]

-- Kill old mpc idleloop player process
awful.spawn.easy_async_with_shell("ps x | grep \"mpc idleloop player\" | grep -v grep | awk '{print $1}' | xargs kill", function ()
    -- Emit song info with each line printed
    awful.spawn.with_line_callback(mpd_script, {
      stdout = function(line)
        emit_info()
      end,
    })
end)
